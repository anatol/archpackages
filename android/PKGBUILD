# Maintainer: Anatol Pomozov anatol dot pomozov at g mail

pkgname=android
pkgver=4.4.2_r2
_tagname=android-$pkgver
pkgrel=1
pkgdesc='Platform designed for touchscreen mobile devices such as smartphones and tablet computers'
arch=(i686 x86_64)
license=(custom)
url='http://developer.android.com/sdk/index.html'
depends=()
makedepends=(gnupg jdk7-openjdk python2)
source=(packages
        remove_restrictions.diff)
sha1sums=('fd02aea83566689c84b8ea9467b0c42b87c07f51'
          'd630a8cf5844e4d97dfd044cf0264c2b0a8d270c')
_url=https://android.googlesource.com

# sdk, sdk-tools, sdk-build-tools, ndk

prepare() {
  mkdir -p android
  cd android

  while read line
  do
    local project=($line)
    local path=${project[0]}
    local name=${project[1]}

    mkdir -p $path
    pushd $path

    if [ -d .git ]; then
      git show-ref --tags --quiet --verify -- refs/tags/$1 && git fetch origin $_tagname --depth=1
    else
      git clone --depth 1 --single-branch --branch $_tagname $_url/$name .
    fi

    if [ $(git describe --dirty --exact-match --tags) != $_tagname ]; then
      git checkout --force $_tagname
      # one needs GPG key to verify the tag http://source.android.com/source/downloading.html
      # git tag $_tagname
    fi

    popd
  done < ../packages

  cp -f build/core/root.mk Makefile

  # TODO: remove warning from build/core/main.mk
  # TODO: fix bison path
  # TODO: remove prebuilds and fix path to g++ at core/combo/HOST_linux-x86.mk
  # TODO: use arch compilation flags
  # TODO: remove projects that are not in packages 
  # TODO: remove java target from core/combo/javac.mk
  # TODO: update external/openssl/Crypto-config.mk to point to x64

  patch -p1 < "$srcdir"/remove_restrictions.diff

  # fix python
  echo 'Fixing python shebangs'
  find build/ frameworks/ -type f -exec \
    sed -e 's_^#!/usr/bin/env python$_&2_' \
        -e 's_^\(#!/usr/bin/python2\).[45]$_\1_' \
        -e 's_^#!/usr/bin/python$_&2_' \
        -e "s_'python'_'python2'_" -i {} \;
}

build() {
  cd android

  source build/envsetup.sh
  lunch sdk-eng
  make sdk

  # tools?
}

package() {
  # repack dist
  # copy license
  return 1
}
